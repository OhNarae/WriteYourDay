<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mappers.diary">

	<select id="getEventList" resultType="vo.DEventVO">
		select * from EVENT_TB 
		where member_seq = #{member_seq} and 
			(start_date between #{start_date} and #{end_date} || end_date between #{start_date} and #{end_date})
		order by event_seq desc
	</select>
	
	<select id="getEvent" resultType="vo.DEventVO">
		select * from EVENT_TB 
		where member_seq = #{member_seq} and event_seq = #{event_seq}
	</select>
	
	<select id="getEventMemo" resultType="vo.MemoVO">
		select * from EVENT_MEMO_TB em 
			join MEMO_SET_TB ms on em.member_seq = ms.member_seq and em.memo_set_seq = ms.seq
			join MEMO_TB m on ms.seq = m.set_seq and em.memo_seq = m.seq
		where em.member_seq = #{member_seq} and em.event_seq = #{event_seq}
	</select>
	
	<insert id="insertEvent">
		<selectKey resultType="string" keyProperty="EventSeq" order="BEFORE">
	        select nvl(max(event_seq), 0)+1 from EVENT_TB where member_seq = #{member_seq}  
	    </selectKey>  
	    
		insert into EVENT_TB ( member_seq, event_seq, title, start_date, end_date, color) 
		values( #{member_seq}, #{EventSeq}, #{title}, #{start_date}, #{end_date},  #{color})
			
		insert into EVENT_MEMO_TB(member_seq, event_seq, memo_set_seq, memo_seq) values	
		<foreach collection="memo_list" item="item" separator=" , ">
            (#{member_seq}, #{EventSeq}, #{item.set_seq}, #{item.seq})
        </foreach>	
	</insert>

</mapper>